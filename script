#!/bin/bash

# =====================================
# CONFIG
# =====================================
SATELLITES=("stl1.local" "stl2.local" "stl3.local" "stl4.local")
PASSWORD="1234"
REMOTE_PATH="~/Documents/messe-ui/backend"

# =====================================
# FUNCTIONS
# =====================================

# Reboot satellite
reboot_satellite() {
    local host=$1
    echo "[REBOOT] Rebooting $host..."
    sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no oleg77@"$host" "sudo reboot" >/dev/null 2>&1 &
}

# Kill python locally
cleanup_local() {
    echo "[CLEANUP] Killing local Python processes..."
    pkill -f python3 || true
}

# Start satellite (runs detached)
start_satellite() {
    local host=$1
    echo "[START] Launching satellite on $host..."
    sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no oleg77@"$host" "bash -lc '
        cd $REMOTE_PATH
        source .venv/bin/activate
        nohup python3 satellite.py > satellite.log 2>&1 &
    '" &
}

# Handle interrupt (Ctrl+C or termination)
handle_interrupt() {
    echo ""
    echo "=============================="
    echo "[INTERRUPT] Caught signal, rebooting satellites..."
    echo "=============================="

    for sat in "${SATELLITES[@]}"; do
        reboot_satellite "$sat"
    done
    cleanup_local
    echo "[DONE] Reboot commands sent. Exiting..."
    exit 0
}

# =====================================
# MAIN SCRIPT
# =====================================

# Trap Ctrl+C (SIGINT) and termination signals
trap handle_interrupt SIGINT SIGTERM

echo "=============================="
echo "[STARTUP] Starting satellites..."
echo "=============================="

# Start satellites
for sat in "${SATELLITES[@]}"; do
    start_satellite "$sat"
done

# Wait a few seconds before starting server
sleep 2

echo "=============================="
echo "[STARTUP] Starting main server..."
echo "=============================="

cd ~/Documents/messe-ui/backend
source .venv/bin/activate
python3 server.py
